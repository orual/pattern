# E2.5 Completion: Trait Swap Finalization

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Complete the trait swap by removing AgentHandle, V1 tool implementations, and Entity macro derives so that `cargo check` shows only expected trait incompatibility errors (E3-E6 work).

**Architecture:** Replace all AgentHandle usages with ToolContext (the new minimal API for tools). Remove Entity macro derives from types in pattern_core and transition to pattern_db models. Old code stays as `.bak` reference files.

**Tech Stack:** Rust, async-trait, pattern_db (SQLite), ToolContext trait

**Reference:** See `docs/plans/2025-01-24-phase-e-integration.md` for full context.

---

## Scope Boundaries

### In Scope (This Plan)
- Remove AgentHandle type and all usages
- Remove V1 tool implementations (RecallTool, ContextTool, SearchTool, SendMessageTool)
- Update BuiltinTools to use only V2 versions
- Update tool tests to use mock ToolContext
- Remove Entity macro derives from core modules
- Fix doc comments (AgentV2 → Agent)

### Out of Scope (Later Work)
- `data_source/` module fixes (staged separately)
- `coordination/groups.rs` Entity derives (requires db schema work)
- Identity module (`atproto_identity.rs`, `discord_identity.rs`) - separate planning
- Auth module (`oauth.rs`) - separate planning
- Export/import module - moves to compat crate later

### Expected Final State
After E2.5, `cargo check -p pattern_core` should show:
- **Expected errors:** Trait method mismatches in heartbeat.rs, coordination patterns (E3-E4 work)
- **No unexpected errors:** No missing imports, no AgentHandle references, no Entity macro failures in core modules

---

## Task 1: Create Mock ToolContext for Tests

**Files:**
- Create: `crates/pattern_core/src/tool/builtin/test_utils.rs`
- Modify: `crates/pattern_core/src/tool/builtin/mod.rs`

**Step 1: Create test_utils.rs with MockToolContext**

```rust
//! Test utilities for built-in tools

use async_trait::async_trait;
use std::sync::Arc;

use crate::memory::{MemoryResult, MemorySearchResult, MemoryStore, SearchOptions};
use crate::permission::PermissionBroker;
use crate::runtime::{AgentMessageRouter, SearchScope, ToolContext};
use crate::ModelProvider;

/// Mock ToolContext for testing V2 tools
pub struct MockToolContext {
    agent_id: String,
    memory: Arc<dyn MemoryStore>,
    router: AgentMessageRouter,
}

impl MockToolContext {
    pub fn new(agent_id: impl Into<String>, memory: Arc<dyn MemoryStore>) -> Self {
        Self {
            agent_id: agent_id.into(),
            memory,
            router: AgentMessageRouter::new_cli(), // Default to CLI router for tests
        }
    }
}

#[async_trait]
impl ToolContext for MockToolContext {
    fn agent_id(&self) -> &str {
        &self.agent_id
    }

    fn memory(&self) -> &dyn MemoryStore {
        self.memory.as_ref()
    }

    fn router(&self) -> &AgentMessageRouter {
        &self.router
    }

    fn model(&self) -> Option<&dyn ModelProvider> {
        None
    }

    fn permission_broker(&self) -> &'static PermissionBroker {
        crate::permission::broker()
    }

    async fn search(
        &self,
        query: &str,
        scope: SearchScope,
        options: SearchOptions,
    ) -> MemoryResult<Vec<MemorySearchResult>> {
        match scope {
            SearchScope::CurrentAgent => {
                self.memory.search(&self.agent_id, query, options).await
            }
            SearchScope::Agent(ref id) => {
                self.memory.search(id.as_str(), query, options).await
            }
            SearchScope::Agents(ref ids) => {
                let mut all = Vec::new();
                for id in ids {
                    if let Ok(results) = self.memory.search(id.as_str(), query, options.clone()).await {
                        all.extend(results);
                    }
                }
                Ok(all)
            }
            SearchScope::Constellation => {
                self.memory.search_all(query, options).await
            }
        }
    }
}
```

**Step 2: Export from mod.rs**

In `crates/pattern_core/src/tool/builtin/mod.rs`, add:

```rust
#[cfg(test)]
mod test_utils;

#[cfg(test)]
pub use test_utils::MockToolContext;
```

**Step 3: Run cargo check**

```bash
cargo check -p pattern_core --lib
```

Expected: May fail due to other issues; this step just adds test infrastructure.

**Step 4: Commit**

```bash
git add crates/pattern_core/src/tool/builtin/test_utils.rs
git add crates/pattern_core/src/tool/builtin/mod.rs
git commit -m "test(tools): add MockToolContext for V2 tool testing"
```

---

## Task 2: Remove V1 RecallTool Implementation

**Files:**
- Modify: `crates/pattern_core/src/tool/builtin/recall.rs`

**Step 1: Remove AgentHandle import**

Remove this line:
```rust
use crate::context::AgentHandle;
```

**Step 2: Remove RecallTool struct and all its impl blocks**

Delete lines 76-459 (the entire `RecallTool` struct, its `AiTool` impl, and helper methods).

Keep only:
- Input/Output types (RecallInput, RecallOutput, ArchivalSearchResult, ArchivalMemoryOperationType)
- RecallToolV2 implementation (lines 461-977)
- Update tests to use V2

**Step 3: Rename RecallToolV2 to RecallTool**

Find and replace in the file:
- `RecallToolV2` → `RecallTool`

**Step 4: Update tests to use MockToolContext**

Replace test code that uses `AgentHandle::test_with_memory` with MockToolContext:

```rust
#[cfg(test)]
mod tests {
    use super::*;
    use crate::tool::builtin::test_utils::MockToolContext;
    use crate::memory::MemoryCache;
    use std::sync::Arc;

    async fn create_test_context() -> Arc<MockToolContext> {
        // Create in-memory test database
        let db = pattern_db::ConstellationDb::open_memory()
            .await
            .expect("Failed to create test db");
        let memory = Arc::new(MemoryCache::new(Arc::new(db)));
        Arc::new(MockToolContext::new("test-agent", memory))
    }

    #[tokio::test]
    async fn test_archival_insert() {
        let ctx = create_test_context().await;
        let tool = RecallTool::new(ctx);

        let result = tool
            .execute(
                RecallInput {
                    operation: ArchivalMemoryOperationType::Insert,
                    content: Some("Test content".to_string()),
                    label: Some("test_label".to_string()),
                },
                &crate::tool::ExecutionMeta::default(),
            )
            .await
            .unwrap();

        assert!(result.success);
    }
}
```

**Step 5: Run cargo check**

```bash
cargo check -p pattern_core --lib
```

**Step 6: Commit**

```bash
git add crates/pattern_core/src/tool/builtin/recall.rs
git commit -m "refactor(tools): remove V1 RecallTool, keep only ToolContext-based version"
```

---

## Task 3: Remove V1 ContextTool Implementation

**Files:**
- Modify: `crates/pattern_core/src/tool/builtin/context.rs`

**Step 1: Remove AgentHandle import and V1 ContextTool**

Same pattern as Task 2:
1. Remove `use crate::context::AgentHandle;`
2. Remove `ContextTool` struct and its `AiTool` impl
3. Rename `ContextToolV2` → `ContextTool`
4. Update tests to use MockToolContext

**Step 2: Commit**

```bash
git add crates/pattern_core/src/tool/builtin/context.rs
git commit -m "refactor(tools): remove V1 ContextTool, keep only ToolContext-based version"
```

---

## Task 4: Remove V1 SearchTool Implementation

**Files:**
- Modify: `crates/pattern_core/src/tool/builtin/search.rs`

Same pattern as Task 2-3.

**Commit message:** `refactor(tools): remove V1 SearchTool, keep only ToolContext-based version`

---

## Task 5: Remove V1 SendMessageTool Implementation

**Files:**
- Modify: `crates/pattern_core/src/tool/builtin/send_message.rs`

Same pattern as Task 2-4.

**Commit message:** `refactor(tools): remove V1 SendMessageTool, keep only ToolContext-based version`

---

## Task 6: Update BuiltinTools to Use V2 Only

**Files:**
- Modify: `crates/pattern_core/src/tool/builtin/mod.rs`

**Step 1: Remove AgentHandle import**

Remove:
```rust
use crate::context::AgentHandle;
```

**Step 2: Remove V1 BuiltinTools struct**

Delete `BuiltinTools` struct (lines 48-56), its `impl` block (lines 58-106), and `BuiltinToolsBuilder` (lines 108-161).

**Step 3: Rename BuiltinToolsV2 to BuiltinTools**

Find and replace:
- `BuiltinToolsV2` → `BuiltinTools`

**Step 4: Update exports**

Remove V2 suffix from public exports:
```rust
pub use context::{ContextInput, ContextOutput, ContextTool, CoreMemoryOperationType};
pub use recall::{
    ArchivalMemoryOperationType, ArchivalSearchResult, RecallInput, RecallOutput, RecallTool,
};
pub use search::{SearchDomain, SearchInput, SearchOutput, SearchTool};
pub use send_message::SendMessageTool;
```

**Step 5: Run cargo check**

```bash
cargo check -p pattern_core --lib
```

**Step 6: Commit**

```bash
git add crates/pattern_core/src/tool/builtin/mod.rs
git commit -m "refactor(tools): consolidate to ToolContext-based BuiltinTools only"
```

---

## Task 7: Remove AgentHandle from Context Module

**Files:**
- Modify: `crates/pattern_core/src/context/mod.rs`

**Step 1: Check current exports**

Read the file and identify any AgentHandle exports or references.

**Step 2: Remove AgentHandle export if present**

If `pub use ... AgentHandle` exists, remove it. The type now lives only in the backup file.

**Step 3: Ensure no other context code references AgentHandle**

Search for AgentHandle in context/*.rs files (excluding .bak).

**Step 4: Commit**

```bash
git add crates/pattern_core/src/context/mod.rs
git commit -m "refactor(context): remove AgentHandle export"
```

---

## Task 8: Fix Doc Comments (AgentV2 → Agent)

**Files:**
- Modify: `crates/pattern_core/src/agent/mod.rs`
- Modify: `crates/pattern_core/src/agent/traits.rs`

**Step 1: Update agent/mod.rs**

Line 3: Change `//! The AgentV2 trait is dramatically slimmer...` to `//! The Agent trait is dramatically slimmer...`

**Step 2: Update agent/traits.rs**

Line 1: Change `//! Core AgentV2 trait...` to `//! Core Agent trait...`
Line 57: Change `/// Extension trait for AgentV2...` to `/// Extension trait for Agent...`
Line 59: Change `...implement AgentV2.` to `...implement Agent.`
Line 76: Change `// Blanket implementation for all AgentV2 types` to `// Blanket implementation for all Agent types`

**Step 3: Commit**

```bash
git add crates/pattern_core/src/agent/mod.rs
git add crates/pattern_core/src/agent/traits.rs
git commit -m "docs(agent): update comments to reflect Agent trait rename"
```

---

## Task 9: Backup and Remove Entity Derives from message.rs

**Files:**
- Backup: `crates/pattern_core/src/message.rs` → `crates/pattern_core/src/message.rs.entity.bak`
- Modify: `crates/pattern_core/src/message.rs`

**Step 1: Create backup of Entity-derived types section**

Copy the Entity-derived structs (Message, AgentMessageRelation) to a .bak file for reference.

**Step 2: Remove Entity derive from Message**

Change:
```rust
#[derive(Debug, Clone, Entity, Serialize, Deserialize)]
#[entity(entity_type = "message")]
pub struct Message {
```

To:
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Message {
```

**Step 3: Remove Entity derive from AgentMessageRelation**

Same pattern - remove `Entity` from derive and remove `#[entity(...)]` attribute.

**Step 4: Remove pattern_macros::Entity import if no longer needed**

**Step 5: Run cargo check**

```bash
cargo check -p pattern_core --lib
```

Expected: Errors where code tries to use Entity trait methods on Message. These indicate code that needs updating to use pattern_db.

**Step 6: Commit**

```bash
git add crates/pattern_core/src/message.rs
git commit -m "refactor(message): remove Entity macro derive, use pattern_db models"
```

---

## Task 10: Backup and Remove Entity Derives from message_queue.rs

**Files:**
- Modify: `crates/pattern_core/src/message_queue.rs`

**Step 1: Remove Entity derives from QueuedMessage and ScheduledWakeup**

Same pattern as Task 9.

**Step 2: Commit**

```bash
git add crates/pattern_core/src/message_queue.rs
git commit -m "refactor(message_queue): remove Entity macro derive"
```

---

## Task 11: Backup and Remove Entity Derives from users.rs

**Files:**
- Modify: `crates/pattern_core/src/users.rs`

Remove Entity derive from User struct.

**Commit message:** `refactor(users): remove Entity macro derive`

---

## Task 12: Handle agent/entity.rs Entity Derives

**Files:**
- Modify: `crates/pattern_core/src/agent/entity.rs`

**Important:** AgentRecord and AgentMemoryRelation are core types. Removing Entity derive will break db_v1 operations.

**Step 1: Remove Entity derives**

Remove `Entity` from derive and `#[entity(...)]` attributes from:
- `AgentRecord`
- `AgentMemoryRelation`

**Step 2: Note resulting errors**

These errors indicate db_v1 code that needs to move to compat crate. This is expected.

**Step 3: Commit**

```bash
git add crates/pattern_core/src/agent/entity.rs
git commit -m "refactor(agent): remove Entity macro derives from AgentRecord

BREAKING: db_v1 operations on AgentRecord will fail.
This is intentional - db_v1 code moves to compat crate."
```

---

## Task 13: Verify Error State

**Step 1: Run full cargo check**

```bash
cargo check -p pattern_core 2>&1 | tee /tmp/e25-final-errors.txt
```

**Step 2: Categorize errors**

Expected errors (E3-E6 work):
- Heartbeat: `trait Agent has no method X`
- Coordination patterns: `process_message_stream` not found
- db_v1 operations: `DbEntity` not implemented

Unexpected errors (fix before proceeding):
- Missing imports unrelated to the changes
- Type errors in unrelated code

**Step 3: Document remaining work**

Create a summary of which errors are expected vs unexpected.

---

## Task 14: Clean Up Empty Directories

**Step 1: Remove empty agent_v2 directory**

```bash
rmdir crates/pattern_core/src/agent_v2
```

**Step 2: Remove empty context_v2 directory**

```bash
rmdir crates/pattern_core/src/context_v2
```

**Step 3: Commit**

```bash
git add -A
git commit -m "chore: remove empty v2 directories after trait swap"
```

---

## Verification Checklist

After completing all tasks:

- [ ] No `AgentHandle` references in non-.bak files (except data_source/ which is out of scope)
- [ ] No `V2` suffix on tool types (RecallTool, not RecallToolV2)
- [ ] No `AgentV2` in doc comments
- [ ] Entity macro only used in out-of-scope files (coordination/groups.rs, identity modules, oauth.rs)
- [ ] `cargo check -p pattern_core` shows only expected trait incompatibility errors
- [ ] All .bak files preserved for reference

---

## Post-E2.5 Work

These errors remain and are addressed in later phases:

1. **E3: Heartbeat Processor** - Update for new Agent trait
2. **E4: Coordination Patterns** - Update for new Agent trait
3. **E5: Message Queue** - Port to pattern_db
4. **E6: CLI/Discord** - Create RuntimeContext
5. **Compat Crate** - Move db_v1, old export/import
6. **Identity/Auth** - Separate planning with database schema work
